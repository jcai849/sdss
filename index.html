<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>reveal.js</title>

	<link rel="stylesheet" href="dist/reset.css">
	<link rel="stylesheet" href="dist/reveal.css">
	<link rel="stylesheet" href="dist/theme/serif.css">
	<link rel="stylesheet" type="text/css" href="css/asciinema-player.css" />
	<link rel="stylesheet" href="node_modules/highlight.js/styles/github.css">
	<link rel="stylesheet" type="text/css" href="node_modules/diff2html/bundles/css/diff2html.min.css" />
	<style>
		span.d2h-code-line-ctn.hljs.plaintext {
			font-size: large;
		}
	</style>
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section>
				<section>
					<h2 class="r-fit-text">Large Scale R</h2>
					<p>Jason Cairns</p>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">The Problem</h2>
				</section>
				<section>
					<ul>
						<li>Larger-than-memory dataset</li>
						<li>Novel model</li>
						<li>Complex algorithm</li>
						<aside class="notes">Expand on each - meaning and examples</aside>
					</ul>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">Feature Requirements</h2>
				</section>
				<section>
					<pre class="r"><code  data-trim data-line-numbers="1|2"><script type="text/template">
						data <- read.distributed.data("airlines")
						my_model_fit <- fit_distributed_model(my_model, data)
					</script></code></pre>
				</section>
				<section>
					<pre class="r"><code  data-trim data-line-numbers="1-3|4"><script type="text/template">
						my_simple_model <- function(...) {
							...
						}
						my_model <- d(my_simple_model)
					</script></code></pre>
					<p>Bonus: Fast, Interactive, Familiar</p>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">The Landscape</h2>
				</section>
				<section>
					<img src="https://upload.wikimedia.org/wikipedia/commons/f/f3/Apache_Spark_logo.svg" width="30%"
						height="30%" alt="Apache Spark">
					<ul>
						<li>Heavyweight</li>
						<li><a
								href="https://spark.apache.org/docs/1.6.0/api/scala/index.html#org.apache.spark.mllib.regression.RidgeRegressionWithSGD">Model
								definition</a> beyond the skills of most statisticians</li>
					</ul>
				</section>
				<section>
					<img src="https://pbdr.org/ui/img/newpbdr.png" width="30%" height="30%" alt="PBDR">
					<ul>
						<li>Very familiar high-level interface</li>
						<li>Built on MPI and ScaLAPACK for matrices</li>
						<li>Limited scope and extensibility</li>
					</ul>
				</section>
				<section>
					<h3>Dask</h3>
					<img src="https://upload.wikimedia.org/wikipedia/commons/1/12/Dask_Logo.svg" width="30%"
						height="30%" alt="Dask">
					<ul>
						<li>Mature System in Python</li>
						<li>Limited mathematical expressibility</li>
					</ul>
					<aside class="notes">Summarise the landscape here</aside>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">New Solution</h2>
				</section>
				<section>
					<h3>Supporting Concepts</h3>
					<div id="graph1" style="text-align: center;"></div>
					<ul>
						<li>Distributed object references chunks</li>
						<li>Computation sent to the data</li>
						<li>Reference possesses structure</li>
					</ul>
				</section>
				<section>
					<h3>API Layers</h3>
					<dl>
						<div class="fragment fade-in">
							<dt>Model Layer</dt>
							<dd>largescalemodelr</dd>
						</div>
						<div class="fragment fade-in">
							<dt>Model Description Layer</dt>
							<dd>largescaler</dd>
						</div>
						<div class="fragment fade-in">
							<dt>Cluster Interaction Layer</dt>
							<dd>chunknet</dd>
						</div>
						<div class="fragment fade-in">
							<dt>Communication Layer</dt>
							<dd>orcv</dd>
						</div>
					</dl>
				</section>
				<section>
					<h3>API Example: Summation</h3>
					<div class="fragment fade-out">
						\[\begin{equation*}
						\sum_i x_i= \sum_{j,i}x_{ij} = \sum_j\sum_i x_{ij}
						\end{equation*} \]
					</div>
					<div class="fragment fade-up">
						<pre class="r"><code data-line-numbers="1|2|3"><script type="text/template">d(sum)(x) |>
emerge() |>
sum()
					</script></code></pre>
					</div>
				</section>
				<section>
					<h3>API Example: Mean</h3>
					<div class="fragment fade-out">
						\[\begin{equation*}
						\overline{x} = \frac{\sum_{i}x_{i}}{n} = \frac{\sum_{j,i}x_{ij}}{\sum_j n_j}
						\end{equation*} \]
					</div>
					<div class="fragment fade-up">
						<pre class="r"><code data-line-numbers="1|2|3"><script type="text/template">dsum(x) / { 
	d(length)(x) |> 
	dsum()
}
						</script></code></pre>
					</div>
				</section>
				<section>
					<h3>API Example: Cumulative Sum</h3>
					<div class="fragment fade-out">
						\[\begin{gather*}
						S_i = S_{i-1}+x_i, \quad S_0 = 0\\
						\iff S_{i,j} = S_{i-1,j} + x_{i,j}, \quad S_{0,j} = S_{n_i,j-1},\\
						\qquad S_{0,0} = 0
						\end{gather*} \]
					</div>
					<div class="fragment fade-up">
						<pre class="r"><code data-line-numbers="1|2"><script type="text/template">dReduce(cumsum, x) |>
emerge()
					</script></code></pre>
					</div>
				</section>
			</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">A More Complex Example</h2>
				</section>
				<section>
					<h3>Data</h3>
					\[\begin{aligned}
					A = \begin{bmatrix}
					A_1\\
					\vdots \\
					A_N
					\end{bmatrix},&amp;
					\quad b=\begin{bmatrix}
					b_1\\
					\vdots \\
					b_N
					\end{bmatrix}\\
					A_i \in \mathbb{R}^{m_i\times n},&amp; \quad b_i \in \mathbb{R}^{m_i}
					\end{aligned} \]
				</section>
				<section>
					<h3>Intention</h3>
					\[\begin{aligned}
					f(x) &amp;= \frac{1}{2} \left\| A_i x_i - b_i \right\|^2_2 \\
					g(z) &amp;= \lambda \left| z \right|_1 \\
					\text{minimise} \quad f(x) + g(z) &amp;\quad \text{subject to} \quad x = z
					\end{aligned} \]
				</section>
				<section>
					<h3>Iterative loop</h3>
					\[\begin{aligned}
					x_i^{k+1} &amp;:= (A_i^T A_i + \rho I)^{-1}(A^T b + \rho(z^k - u_i^k))\\
					z^{k+1} &amp;:= S_\frac{\lambda}{\rho N} (\overline{x}^{k+1} + \overline{u}^k) \\
					u_i^{k+1} &amp;:= u_i^k + x_i^{k+1} - z^{k+1}
					\end{aligned} \]
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">A More Complex API</h2>
				</section>
				<section>
					<h3>Data</h3>
					<div id="seq-par-diff1"></div>
				</section>
				<section>
					<h3>Iterative Loop</h3>
					<div id="seq-par-diff2"></div>
				</section>
				<section>
					<h3>Magic</h3>
					<div id="seq-par-diff3"></div>
				</section>
				<section>
					<h3>The Code in Action</h3>
					<div id="asciicast" class="player"></div>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">Close</h2>
				</section>
				<section>
					<h3>Conclusion</h3>
					<ul>
						<li>Key Takeaway: Basic conceptual knowledge, paired with a simple layered API,
							allows for straightforward implementation of complex and iterative distributed statistical
							models
						</li>
						<li>Limitations:<ul>
								<li>Still in development</li>
								<li>No monitoring or resilience</li>
								<li>...</li>
							</ul>
						</li>
					</ul>
				</section>
				<section>
					<div id="graph2"></div>
					<ul>
						<li><a href="https://jason.cair.nz">https://jason.cair.nz</a></li>
						<li><a href="https://github.com/jcai849">https://github.com/jcai849</a></li>
					</ul>
				</section>
				<section>
					<div id="graph3"></div>
					<ul>

						<li><a href="https://jason.cair.nz">https://jason.cair.nz</a></li>
						<li><a href="https://github.com/jcai849">https://github.com/jcai849</a></li>
					</ul>
				</section>
			</section>
		</div>
	</div>

	<script src="dist/reveal.js"></script>
	<script src="plugin/notes/notes.js"></script>
	<script src="plugin/markdown/markdown.js"></script>
	<script src="plugin/highlight/highlight.js"></script>
	<script src="plugin/math/math.js"></script>
	<script src="js/asciinema-player.min.js"></script>
	<script src="node_modules/d3/dist/d3.js"></script>
	<script src="node_modules/@hpcc-js/wasm/dist/graphviz.umd.js"></script>
	<script src="node_modules/d3-graphviz/build/d3-graphviz.js"></script>
	<script src="node_modules/diff2html/bundles/js/diff2html-ui.min.js"></script>
	<script src="graphs.js"></script>

	<script>
		(async () => {
			const static_graph_response = await fetch("graphs/distobjref.gv");
			const static_graph_dot = await static_graph_response.text();
			d3.select("#graph1").graphviz().renderDot(static_graph_dot);

			const dynamic_graph_responses_ncm = [...Array(5).keys()].map(x => "graphs/no-chunk-movement/distobjref" + x + ".gv")
				.map(x => fetch(x).then((response) => response.text()));
			const dynamic_graph_dot_ncm = await Promise.all(dynamic_graph_responses_ncm);
			anim_graph('#graph2', dynamic_graph_dot_ncm)

			const dynamic_graph_responses_cm = [...Array(9).keys()].map(x => "graphs/chunk-movement/distobjref" + x + ".gv")
				.map(x => fetch(x).then((response) => response.text()));
			const dynamic_graph_dot_cm = await Promise.all(dynamic_graph_responses_cm);
			anim_graph('#graph3', dynamic_graph_dot_cm)


			function draw_diff(target_id, text) {
				const diff_configuration = {
					outputFormat: 'side-by-side',
					drawFileList: false,
					matching: 'words',
					highlight: true,
					stickyFileHeaders: false,
					highlightLanguages: "R",
					fileListToggle: false,
					fileContentToggle: false
				};
				const diff_target = document.getElementById(target_id);
				console.log(target_id);
				console.log(diff_target);
				const diff2htmlUi = new Diff2HtmlUI(diff_target, text, diff_configuration);
				diff2htmlUi.draw();
				diff2htmlUi.highlightCode();
			}
			const diff_responses_cm = [...Array(3).keys()].map(x => "diffs/seqpar" + (x + 1) + ".diff")
				.map(x => fetch(x).then((response) => response.text()));
			const diff_texts = await Promise.all(diff_responses_cm);

			for (i in diff_texts) draw_diff("seq-par-diff" + (Number(i) + 1), diff_texts[i]);
			var headers = document.getElementsByClassName('d2h-file-header');
			while (headers[0]) headers[0].parentNode.removeChild(headers[0]);

			AsciinemaPlayer.create('lasso.cast', document.getElementById('asciicast'));

			Reveal.initialize({
				hash: true,
				plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealMath.KaTeX]
			});
		})();
	</script>
</body>

</html>