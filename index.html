<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>reveal.js</title>

	<link rel="stylesheet" href="dist/reset.css">
	<link rel="stylesheet" href="dist/reveal.css">
	<link rel="stylesheet" href="dist/theme/black.css">
	<link rel="stylesheet" type="text/css" href="css/asciinema-player.css" />
	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="plugin/highlight/monokai.css">
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section>
				<section>
					<h2 class="r-fit-text">Large Scale R</h2>
					<p>Jason Cairns</p>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">The Problem</h2>
				</section>
				<section>
					<ul>
						<li>Larger-than-memory dataset</li>
						<li>Novel model</li>
						<li>Complex algorithm</li>
						<aside class="notes">Expand on each - meaning and examples</aside>
					</ul>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">Feature Requirements</h2>
				</section>
				<section>
					<pre><code  data-trim data-line-numbers="1|2"><script type="text/template">
						data <- read.distributed.data("airlines")
						dglm(data)
					</script></code></pre>
				</section>
				<section>
					<pre><code><script type="text/template">
						dglm <- d(function(...) {
							...
						})
					</script></code></pre>
					<p>Bonus: Fast, Interactive, Familiar</p>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">The Landscape</h2>
				</section>
				<section>
					<h3>Spark</h3>
					<ul>
						<li>Heavyweight</li>
						<li><a
								href="https://spark.apache.org/docs/1.6.0/api/scala/index.html#org.apache.spark.mllib.regression.RidgeRegressionWithSGD">Model
								definition</a> beyond the skills of most statisticians</li>
					</ul>
				</section>
				<section>
					<h3>pbdDMAT</h3>
					<ul>
						<li>Very familiar high-level interface</li>
						<li>Built on MPI and ScaLAPACK for matrices</li>
					</ul>
				</section>
				<section>
					<h3>Dask</h3>
					<ul>
						<li>Mature System in Python</li>
						<li>Executable pseudocode, not executable math</li>
					</ul>
					<aside class="notes">Summarise the landscape here</aside>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">New Solution Dependencies</h2>
				</section>
				<section>
					<h3>Supporting Concepts</h3>
					<div id="graph1" style="text-align: center;"></div>
					<ul>
						<li>Distributed object references chunks</li>
						<li>Computation sent to the data</li>
					</ul>
				</section>
				<section>
					<h3>Supporting Program Layers</h3>
					<ul>
						<li>Model definition:
							<pre><code>d(f)</code></pre>
						</li>
						<li>Communication</li>
					</ul>
					<aside class="notes">Expand: meaning and examples</aside>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">Example "Distributed" Math</h2>
				</section>
				<section>
					<h3>Data</h3>
					\[\begin{aligned}
					A = \begin{bmatrix}
					A_1\\
					\vdots \\
					A_N
					\end{bmatrix},&amp;
					\quad b=\begin{bmatrix}
					b_1\\
					\vdots \\
					b_N
					\end{bmatrix}\\
					A_i \in \mathbb{R}^{m_i\times n},&amp; \quad b_i \in \mathbb{R}^{m_i}
					\end{aligned} \]
				</section>
				<section>
					<h3>Intention</h3>
					\[\begin{aligned}
					f(x) &amp;= \frac{1}{2} \left\| A_i x_i - b_i \right\|^2_2 \\
					g(z) &amp;= \lambda \left| z \right|_1 \\
					\text{minimise} \quad f(x) + g(z) &amp;\quad \text{subject to} \quad x = z
					\end{aligned} \]
				</section>
				<section>
					<h3>Iterative loop</h3>
					\[\begin{aligned}
					x_i^{k+1} &amp;:= (A_i^T A_i + \rho I)^{-1}(A^T b + \rho(z^k - u_i^k))\\
					z^{k+1} &amp;:= S_\frac{\lambda}{\rho N} (\overline{x}^{k+1} + \overline{u}^k) \\
					u_i^{k+1} &amp;:= u_i^k + x_i^{k+1} - z^{k+1}
					\end{aligned} \]
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">Example Local "Distributed" Code</h2>
				</section>
				<section>
					<h3>Data</h3>
					<pre><code><script type="text/template">
						S <- function(kappa) function(alpha) pmax(alpha-kappa, 0) - pmax(-alpha-kappa, 0)
						p_norm <- function(p) function(x) sum(abs(x)^p)^(1/p)
						l1_norm <- p_norm(1)
						l2_norm <- p_norm(2)
						
						A <- matrix(runif(m*n), n, m)
						chunks_i <- tapply(seq(n), cut(seq(n), N), identity, simplify=F)
						A <- lapply(chunks_i, function(i, x) x[i,], A)
						b <- lapply(chunks_i, function(i, x) x[i], b)
					</script></code></pre>
				</section>
				<section>
					<h3>Initialisation</h3>
					<pre><code><script type="text/template">
						lasso <- function(A, b, tolerance=1, rho=3, lambda=rho) {
							M_N <- dim(A)
							m <- ncol(A)
							S_z <- S(lambda/(rho*M_N[2]))
						
							z_prev <- rep(Inf, m)
							x_prev <- u_prev <- rep(list(z_prev), N)
							z_curr <- rep(1, m)
							x_curr <- u_curr <- rep(list(z_curr), N)
					</script></code></pre>
				</section>
				<section>
					<h3>Iterative Loop</h3>
					<pre><code><script type="text/template">
						while (l1_norm(z_curr - z_prev) > tolerance) {
							x_prev <- x_curr; z_prev <- z_curr; u_prev <- u_curr
							x_curr <- mapply(x.update, x_prev, A, b, u_prev, MoreArgs = list(rho, z_prev), SIMPLIFY = FALSE)
							x_local <- unlist(x_curr); u_local <- unlist(u_curr); dim(x_local) <- dim(u_local) <- c(m, N)
							z_curr <- S_z(rowMeans(x_local) + rowMeans(u_local))
							u_curr <- mapply(function(u_prev, x_curr, z_curr) u_prev + x_curr - z_curr, u_prev, x_curr, MoreArgs = list(z_curr), SIMPLIFY = FALSE)
						}
						z_curr
					}
					</script></code></pre>
				</section>
				<section>
					<h3>Update Function</h3>
					<pre><code><script type="text/template">
						x_update <- function(x_prev, A, b, u_prev, rho, z_prev) {
							optim(x_prev,
								function(x_prev) (1/2)*l2_norm(A %*% x_prev - b)^2 +
												(rho/2)*l2_norm(x_prev - z_prev + u_prev)^2)$par
						}
					</script></code></pre>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">Largescaler Solution</h2>
				</section>
				<section data-background-iframe="diff.html" data-background-interactive>
				</section>
				<section>
					<h3>The Code in Action</h3>
					<div id="asciicast" class="player"></div>
					<aside class="notes">Note the existence of lower communication layer - comment on elasticity, p2p
					</aside>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">More Details</h2>
				</section>
				<section>
					<div id="graph2"></div>
				</section>
				<section>
					<div id="graph3"></div>
				</section>
			</section>
			<section>
				<section>
					<h2 class="r-fit-text">Close</h2>
				</section>
				<section>
					<h3>Conclusion</h3>
					<ul>
						<li>Key Takeaway: There's a new system in R that gets to the essence of distributed modelling,
							with interfaces at multiple layers</li>
						<li>Limitations:<ul>
								<li>Still in development</li>
								<li>No monitoring or resilience</li>
							</ul>
						</li>
					</ul>
				</section>
				<section>
					<img class="r-stretch" src="qr-code.svg">
				</section>
			</section>
		</div>
	</div>

	<script src="dist/reveal.js"></script>
	<script src="plugin/notes/notes.js"></script>
	<script src="plugin/markdown/markdown.js"></script>
	<script src="plugin/highlight/highlight.js"></script>
	<script src="plugin/math/math.js"></script>
	<script src="js/asciinema-player.min.js"></script>
	<script src="node_modules/d3/dist/d3.js"></script>
	<script src="node_modules/@hpcc-js/wasm/dist/graphviz.umd.js"></script>
	<script src="node_modules/d3-graphviz/build/d3-graphviz.js"></script>
	<script src="graphs.js"></script>

	<script>
		(async () => {
			const static_graph_response = await fetch("graphs/distobjref.gv");
			const static_graph_dot = await static_graph_response.text();
			d3.select("#graph1").graphviz().renderDot(static_graph_dot);

			const dynamic_graph_responses_ncm = [...Array(5).keys()].map(x => "graphs/no-chunk-movement/distobjref" + x + ".gv")
				.map(x => fetch(x).then((response) => response.text()));
			const dynamic_graph_dot_ncm = await Promise.all(dynamic_graph_responses_ncm);
			anim_graph('#graph2', dynamic_graph_dot_ncm)

			const dynamic_graph_responses_cm = [...Array(9).keys()].map(x => "graphs/chunk-movement/distobjref" + x + ".gv")
				.map(x => fetch(x).then((response) => response.text()));
			const dynamic_graph_dot_cm = await Promise.all(dynamic_graph_responses_cm);
			anim_graph('#graph3', dynamic_graph_dot_cm)

			AsciinemaPlayer.create('lasso.cast', document.getElementById('asciicast'));
			Reveal.initialize({
				hash: true,
				plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealMath.KaTeX]
			});
		})();
	</script>
</body>

</html>